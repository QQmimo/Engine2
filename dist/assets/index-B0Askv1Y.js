var X=Object.defineProperty;var Y=(r,e,t)=>e in r?X(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var i=(r,e,t)=>Y(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();class A{constructor(e){i(this,"Object");this.Object=e}update(e){}}class b{static new(){const e="0123456789ABCDEF";return"xxxxxxxx-xxxx-4xxx-xxxx-xxxxxxxxxxxx".replace(/x/g,()=>e.charAt(Math.random()*e.length))}}class d{constructor(e,t){i(this,"X");i(this,"Y");this.X=e,this.Y=t}add(e){return new d(this.X+e.X,this.Y+e.Y)}subtract(e){return new d(this.X-e.X,this.Y-e.Y)}normalize(){const e=this.Length;return new d(this.X/e,this.Y/e)}dot(e){return this.X*e.X+this.Y*e.Y}multiply(e){return new d(this.X*e,this.Y*e)}distance(e){return this.subtract(e).Length}get Length(){return Math.sqrt(this.X*this.X+this.Y*this.Y)}get IsZero(){return this.X===0&&this.Y===0}}class I extends Number{toDegree(){return this.valueOf()*180/Math.PI}toRadian(){return this.valueOf()}static degree(e){return new I(e*Math.PI/180)}static byPoints(e,t){const s=e instanceof m?e.Transform.Position:e,n=t instanceof m?t.Transform.Position:t;return new I(Math.atan2(n.Y-s.Y,n.X-s.X))}}class k{constructor(e,t){i(this,"Width");i(this,"Height");this.Width=e,this.Height=t}}class B{constructor(e,t,s=new k(1,1)){i(this,"_Scale");i(this,"_Width");i(this,"_Height");this._Scale=s,this._Width=e*s.Width,this._Height=t*s.Height}get Scale(){return this._Scale}set Scale(e){this._Scale=e}get Width(){return this._Width}set Width(e){this._Width=e*this.Scale.Width}get Height(){return this._Height}set Height(e){this._Height=e*this.Scale.Height}}class u{static Float(e,t){return typeof t>"u"?Math.random()*e:Math.random()*(t-e+1)+e}static Integer(e,t){return Math.floor(u.Float(e,t))}static ColorRGB(){return`rgb(${u.Integer(255)}, ${u.Integer(255)}, ${u.Integer(255)})`}static ColorHEX(){const e="0123456789ABCDEF";return"#xxxxxx".replace(/x/g,()=>e.charAt(Math.random()*e.length))}static Boolean(){return u.Integer(0,1)===1}static Angle(e=360){return I.degree(u.Integer(e))}static Vector2D(e,t,s,n){return new d(u.Float(e,t),u.Float(s,n))}}const _=class _{constructor(e){i(this,"Name");i(this,"Id");i(this,"Tags");i(this,"_onDestroy");i(this,"_onUpdate");this.Id=b.new(),this.Name=e,this.Tags=new Set,_.add(this)}onDestroy(e){this._onDestroy=e}onUpdate(e){this._onUpdate=e}addTag(e){this.Tags.add(e)}deleteTag(e){this.Tags.delete(e)}destroy(){var e;_.delete(this.Id),(e=this._onDestroy)==null||e.apply(this)}static get AllAsArray(){const e=[];return this.All.forEach(t=>t.constructor.name===this.name?e.push(t):null),e}static add(e){if(_.findById(e.Id))throw new Error(`ОШИБКА: ${this.name} c идентификатором '${e.Id}' уже существует.`);this.All.set(e.Id,e)}static findById(e){return this.AllAsArray.find(t=>this.name===t.constructor.name&&t.Id===e)??null}static findByName(e){return this.AllAsArray.find(t=>this.name===t.constructor.name&&t.Name===e)??null}static selectByTag(e){return this.AllAsArray.filter(t=>t.Tags.has(e))}static showAll(){return this.AllAsArray}static delete(e){this.All.delete(e)}};i(_,"All",new Map);let S=_;class L extends S{constructor(t,s,n,o){super(s??`GameScreen_${L.showAll().length+1}`);i(this,"_LastTime",0);i(this,"_Loop",0);i(this,"_GameEngine");i(this,"Scenes");i(this,"Canvas");i(this,"Context");i(this,"_onAddScene");i(this,"_onClick");i(this,"_onRightClick");i(this,"_onMouseMove");i(this,"_onKeyDown");i(this,"_onKeyUp");i(this,"play",(t=0)=>{const s=(t-this._LastTime)/1e3;this._LastTime=t,this.update(s),this._Loop=requestAnimationFrame(this.play)});i(this,"pause",()=>{cancelAnimationFrame(this._Loop)});i(this,"_IsShowFPS",!1);i(this,"_Times",[]);i(this,"_onShowFPS",()=>{const t=performance.now();for(;this._Times.length>0&&this._Times[0]<=t-1e3;)this._Times.shift();return this._Times.push(t),this._Times.length});i(this,"showFPS",(t=!0)=>{this._IsShowFPS=t});i(this,"_IsShowEntitiesCount",!1);i(this,"showEntitiesCount",(t=!0)=>{this._IsShowEntitiesCount=t});this.Scenes=new Map,this.Canvas=document.createElement("canvas"),this.Context=this.Canvas.getContext("2d"),t.appendChild(this.Canvas),this._setSize(),window.addEventListener("resize",()=>{this._setSize()}),this.Canvas.addEventListener("click",a=>{var c;(c=this._onClick)==null||c.apply(this,[new d(a.clientX,a.clientY),this])}),this.Canvas.addEventListener("contextmenu",a=>{var c;a.preventDefault(),(c=this._onRightClick)==null||c.apply(this,[new d(a.clientX,a.clientY),this])}),this.Canvas.addEventListener("mousemove",a=>{var c;(c=this._onMouseMove)==null||c.apply(this,[new d(a.clientX,a.clientY),this])}),window.addEventListener("keydown",a=>{var c;(c=this._onKeyDown)==null||c.apply(this,[a.key])}),window.addEventListener("keyup",a=>{var c;(c=this._onKeyUp)==null||c.apply(this,[a.key])}),this._GameEngine=new W,this.setGridSize(150,150)}_setSize(){this.Canvas.width=innerWidth,this.Canvas.height=innerHeight,this.Canvas.style.cssText="position: absolute; top: 0; left: 0;"}get Width(){return this.Canvas.width}get Height(){return this.Canvas.height}get Areas(){return this._GameEngine.Areas}onAddScene(t){this._onAddScene=t}onClick(t){this._onClick=t}onRightClick(t){this._onRightClick=t}onMouseMove(t){this._onMouseMove=t}onKeyDown(t){this._onKeyDown=t}onKeyUp(t){this._onKeyUp=t}setGridSize(t,s,n=this.Width,o=this.Height,a=0,c=0){this._GameEngine.setGrid(t,s,n,o,a,c)}addScene(t){var n;const s=new P(this,t);if(this.findSceneById(s.Id)!==null)throw new Error(`ОШИБКА: ${s.constructor.name} с идентификатором '${s.Id}' уже существует.`);return this.Scenes.set(s.Id,s),(n=this._onAddScene)==null||n.apply(this,[s]),s}destroyScene(t){var s;(s=P.findById(t))==null||s.destroy()}findSceneById(t){return this.Scenes.get(t)??null}update(t){var s,n;this._GameEngine.update(t),(s=this.Context)==null||s.clearRect(0,0,this.Width,this.Height),this._GameEngine.Areas.forEach(o=>{var a;(a=this.Context)==null||a.restore(),this.Context.beginPath(),this.Context.strokeRect(o.minX,o.minY,o.maxX-o.minX,o.maxY-o.minY),this.Context.strokeStyle="rgba(255, 125, 0, 0.5)",this.Context.stroke(),this.Context.closePath()}),this.Scenes.forEach(o=>{var a;o.update(t),(a=this.Context)==null||a.restore()}),(n=this._onUpdate)==null||n.apply(this,[t]),this._IsShowFPS&&(this.Context.beginPath(),this.Context.globalAlpha=.75,this.Context.fillStyle="black",this.Context.fillRect(10,10,70,24),this.Context.closePath(),this.Context.beginPath(),this.Context.globalAlpha=1,this.Context.textAlign="left",this.Context.strokeStyle="#00fb00",this.Context.textBaseline="middle",this.Context.font="lighter 18px sans-serif",this.Context.fillStyle="#00fb00",this.Context.fillText(`FPS: ${this._onShowFPS()}`,12,22,70),this.Context.closePath()),this._IsShowEntitiesCount&&(this.Context.beginPath(),this.Context.globalAlpha=.75,this.Context.fillStyle="black",this.Context.fillRect(10,35,100,24),this.Context.closePath(),this.Context.beginPath(),this.Context.globalAlpha=1,this.Context.textAlign="left",this.Context.strokeStyle="#00fb00",this.Context.font="lighter 18px sans-serif",this.Context.fillStyle="#00fb00",this.Context.fillText(`Count: ${m.AllAsArray.length}`,12,47),this.Context.closePath())}destroy(){var t;(t=this.Canvas.parentElement)==null||t.removeChild(this.Canvas),this.Scenes.forEach(s=>s.destroy()),super.destroy()}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static selectByTag(t){return super.selectByTag(t)}static showAll(){return this.AllAsArray}}class P extends S{constructor(t,s){super(s??`GameScene_${P.showAll().length+1}`);i(this,"Layers");i(this,"Screen");i(this,"_onAddLayer");this.Layers=new Map,this.Screen=t}onAddLayer(t){this._onAddLayer=t}update(t){this.Layers.forEach(s=>s.update(t))}addLayer(t){var n;const s=new v(this,t);if(this.findLayerById(s.Id)!==null)throw new Error(`ОШИБКА: ${s.constructor.name} с идентификатором '${s.Id}' уже существует.`);return this.Layers.set(s.Id,s),(n=this._onAddLayer)==null||n.apply(this,[s]),s}destroyLayer(t){var s;(s=this.findLayerById(t))==null||s.destroy()}findLayerById(t){return this.Layers.get(t)??null}destroy(){this.Layers.forEach(t=>t.destroy()),super.destroy()}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static selectByTag(t){return super.selectByTag(t)}static showAll(){return super.showAll()}}class v extends S{constructor(t,s){super(s??`GameLayer_${v.showAll().length+1}`);i(this,"Objects");i(this,"Scene");i(this,"_onAddObject");this.Objects=new Map,this.Scene=t}onAddObject(t){this._onAddObject=t}update(t){this.Objects.forEach(s=>s.update(t))}createObject(t){var n;const s=new m(this,t);if(this.findObjectById(s.Id)!==null)throw new Error(`ОШИБКА: ${s.constructor.name} с идентификатором '${s.Id}' уже существует.`);return this.Objects.set(s.Id,s),(n=this._onAddObject)==null||n.apply(this,[s]),s}addObject(t){var s;return this.Objects.set(t.Id,t),(s=this._onAddObject)==null||s.apply(this,[t]),t}destroyObject(t){this.Objects.delete(t)}findObjectById(t){return this.Objects.get(t)??null}destroy(){this.Objects.forEach(t=>t.destroy()),super.destroy()}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static selectByTag(t){return super.selectByTag(t)}static showAll(){return super.showAll()}}class m extends S{constructor(t,s){super(s??`GameObject_${m.showAll().length+1}`);i(this,"_Layer");i(this,"Components");this.Components=new Map,this.Layer=t,[M].forEach(n=>this.addComponent(n))}get Layer(){return this._Layer}set Layer(t){t.addObject(this),this._Layer=t}get Transform(){return this.getComponent(M)}addComponent(t){const s=new t(this);return this.Components.set(t.name,s),s}getComponent(t){const s=this.Components.get(t.name);if(s===void 0)throw new Error(`ОШИБКА: Компонент '${t.name}' не найден.`);return s}tryGetComponent(t){return this.Components.get(t.name)}destroyComponent(t){this.Components.delete(t.name)}update(t){var s;this.Components.forEach(n=>{n.update(t)}),(s=this._onUpdate)==null||s.apply(this,[t])}destroy(){this.Layer.destroyObject(this.Id),super.destroy()}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static selectByTag(t){return super.selectByTag(t)}static showAll(){return super.showAll()}static selectByComponent(t){return super.showAll().filter(s=>s instanceof m&&s.tryGetComponent(t))}}class W{constructor(){i(this,"_Gravity",0);i(this,"_MetrByPixels",1);i(this,"_Areas",[])}get Gravity(){return this._Gravity*this.MetrByPixels}set Gravity(e){this._Gravity=e/this.MetrByPixels}get MetrByPixels(){return this._MetrByPixels}set MetrByPixels(e){const t=this._Gravity*this._MetrByPixels;this._MetrByPixels=e,this.Gravity=t}get Areas(){return this._Areas}setGrid(e,t,s,n,o=0,a=0){const c=Math.ceil((n+a)/t),p=Math.ceil((s+o)/e);for(let f=0;f<c;f++)for(let w=0;w<p;w++)this._Areas.push({minX:(w-1)*e+o,minY:(f-1)*t+a,maxX:(w+1)*e+o,maxY:(f+1)*t+a})}_updatePhysic(e){const t=m.selectByComponent(l).filter(s=>s.getComponent(l).IsCollidable);this._Areas.forEach(s=>{const n=t.filter(o=>o.Transform.Position.X>s.minX&&o.Transform.Position.Y>s.minY&&o.Transform.Position.X<s.maxX&&o.Transform.Position.Y<s.maxY);for(let o=0;o<n.length;o++)for(let a=n.length-1;a>=0&&n[o].Id!==n[a].Id;a--)n[o].getComponent(l).checkCollision(n[a])})}update(e){this._updatePhysic(e)}}class M extends A{constructor(){super(...arguments);i(this,"Position",new d(0,0));i(this,"Rotation",new I(0));i(this,"Size",new B(50,50));i(this,"Fill")}}class l extends A{constructor(){super(...arguments);i(this,"Mass",0);i(this,"Flex",.4);i(this,"IsCollidable",!1);i(this,"_Velocity",new d(0,0));i(this,"_onMoving");i(this,"_onStoped");i(this,"_onCollision")}get Velocity(){return this._Velocity}get IsMoving(){return!this.Velocity.IsZero}onMoving(t){this._onMoving=t}onStoped(t){this._onStoped=t}onCollision(t){this._onCollision=t}addForce(t){this._Velocity=this._Velocity.add(t)}stop(){this._Velocity=new d(0,0)}_bounce(t){var F;let s=this.Object.tryGetComponent(l);s===null&&(s=this.Object.addComponent(l));const n=s.Velocity.subtract(((F=t.tryGetComponent(l))==null?void 0:F.Velocity)??new d(0,0)),o=this.Object.Transform.Position.X-t.Transform.Position.X,a=this.Object.Transform.Position.Y-t.Transform.Position.Y,c=Math.sqrt(o*o+a*a),p=new d(o/c,a/c).normalize(),f=n.dot(p);if(f>0)return;const w=-(1+this.Flex+t.getComponent(l).Flex)*f,G=(this.Mass!==1/0?1/this.Mass:0)+(t.tryGetComponent(l).Mass!==1/0?1/t.tryGetComponent(l).Mass:0),T=w/G;this.Mass!==1/0&&s.addForce(new d(T*p.X/this.Mass,T*p.Y/this.Mass)),t.tryGetComponent(l).Mass!==1/0&&t.tryGetComponent(l).addForce(new d(-(T*p.X)/t.tryGetComponent(l).Mass,-(T*p.Y)/t.tryGetComponent(l).Mass))}checkCollision(t){var s,n;return this.IsCollidable&&this.Object.Transform.Position.subtract(t.Transform.Position).Length<this.Object.Transform.Size.Width+t.Transform.Size.Width?((s=this._onCollision)==null||s.apply(this,[t,this]),(n=t.getComponent(l)._onCollision)==null||n.apply(this,[this.Object,t.getComponent(l)]),this._bounce(t),!0):!1}update(t){var s,n;this.Object.Transform.Position=this.Object.Transform.Position.add(this.Velocity.multiply(t)),this.IsMoving?(s=this._onMoving)==null||s.apply(this,[this.Object,this]):(n=this._onStoped)==null||n.apply(this,[this.Object,this])}}class E extends A{get _Screen(){return this.Object.Layer.Scene.Screen}update(e){this._Screen.Context.beginPath(),this._Screen.Context.arc(this.Object.Transform.Position.X,this.Object.Transform.Position.Y,this.Object.Transform.Size.Width,0,360),this._Screen.Context.fillStyle=this.Object.Transform.Fill,this._Screen.Context.fill(),this._Screen.Context.closePath()}}class C extends A{constructor(){super(...arguments);i(this,"_Dictionary",new Map)}set(t,s){this._Dictionary.set(t,s)}get(t){return this._Dictionary.get(t)}}const h=new L(document.body),z=h.addScene(),O=z.addLayer();h.setGridSize(75,75);console.log(h.Areas);for(let r=0;r<500;r++){const e=new m(O);e.addComponent(E),e.addComponent(l),e.addComponent(C),e.getComponent(C).set("timeId",null),e.Transform.Position=u.Vector2D(0,h.Width,0,h.Height),e.Transform.Size=new B(u.Integer(10,25),0),e.Transform.Fill="Green";const t=e.getComponent(l);t.Mass=e.Transform.Size.Width*2,t.IsCollidable=!0,t.addForce(new d(u.Integer(-25,25),u.Integer(-25,25))),t.onCollision((s,n)=>{if(s.Tags.has("player")){let o=n.Object.getComponent(C).get("timeId");o!==null&&(clearTimeout(o),n.Object.Transform.Fill="Green"),n.Object.Transform.Fill="Red",o=setTimeout(()=>{n.Object.Transform.Fill="Green"},250),n.Object.getComponent(C).set("timeId",o)}else{let o=s.getComponent(C).get("timeId");o!==null&&(clearTimeout(o),s.Transform.Fill="Green"),s.Transform.Fill="Red",o=setTimeout(()=>{s.Transform.Fill="Green"},250),s.getComponent(C).set("timeId",o)}})}const y=new m(O);y.Transform.Position=u.Vector2D(0,h.Width,0,h.Height);y.Transform.Size=new B(100,0);y.Transform.Fill="Orange";y.Tags.add("player");y.addComponent(l);y.addComponent(E);y.addComponent(C);const x=y.getComponent(l);x.Mass=1e4;x.Flex=0;x.IsCollidable=!0;h.onKeyDown(r=>{r==="w"&&x.addForce(new d(0,-5)),r==="s"&&x.addForce(new d(0,5)),r==="a"&&x.addForce(new d(-5,0)),r==="d"&&x.addForce(new d(5,0))});const g=new d(h.Width/2,h.Height/2),D=m.selectByComponent(l).filter(r=>r.getComponent(l).IsCollidable);h.onUpdate(()=>{h.Context.beginPath(),h.Context.arc(g.X,g.Y,10,0,360),h.Context.fillStyle="Black",h.Context.fill(),h.Context.closePath(),D.forEach(r=>{r.Tags.has("player")||(r.Transform.Position.distance(g)>u.Integer(10,250)?r.getComponent(l).addForce(g.subtract(r.Transform.Position).normalize().multiply(1/10)):(r.getComponent(l).addForce(g.subtract(r.Transform.Position).normalize().multiply(-2)),h.Context.beginPath(),h.Context.moveTo(r.Transform.Position.X,r.Transform.Position.Y),h.Context.lineTo(g.X,g.Y),h.Context.strokeStyle="rgba(51, 51, 51, 0.25)",h.Context.stroke(),h.Context.closePath())),h.Context.beginPath(),h.Context.moveTo(r.Transform.Position.X,r.Transform.Position.Y),h.Context.lineTo(r.Transform.Position.X+r.getComponent(l).Velocity.X,r.Transform.Position.Y+r.getComponent(l).Velocity.Y),h.Context.strokeStyle="Black",h.Context.stroke(),h.Context.closePath()}),y.getComponent(l).Velocity.IsZero||y.getComponent(l).addForce(y.getComponent(l).Velocity.multiply(-1/100))});h.showFPS();h.showEntitiesCount();h.play();
